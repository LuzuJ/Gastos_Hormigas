name: üîç PR Validation & Preview

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '18'

jobs:
  # ===== VALIDACI√ìN B√ÅSICA =====
  pr-validation:
    name: üîç PR Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì¶ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üßπ Lint check
        run: npm run lint

      - name: üîç Type check
        run: npx tsc --noEmit

      - name: üß™ Run tests
        run: npm run test -- --coverage
        env:
          CI: true

      - name: üìä Comment coverage report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('./coverage/lcov-report/index.html')) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '‚úÖ Tests pasaron correctamente. Coverage report generado.'
              });
            }

  # ===== BUILD DE PREVIEW =====
  preview-build:
    name: üèóÔ∏è Preview Build
    runs-on: ubuntu-latest
    needs: pr-validation
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üèóÔ∏è Build for preview
        run: npm run build
        env:
          VITE_APP_ENV: preview
          VITE_APP_VERSION: pr-${{ github.event.number }}
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: üì§ Upload preview build
        uses: actions/upload-artifact@v4
        with:
          name: preview-build-${{ github.event.number }}
          path: dist/
          retention-days: 7

  # ===== DEPLOY PREVIEW =====
  deploy-preview:
    name: üöÄ Deploy Preview
    runs-on: ubuntu-latest
    needs: preview-build
    if: github.event.action != 'closed'
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üì• Download preview build
        uses: actions/download-artifact@v4
        with:
          name: preview-build-${{ github.event.number }}
          path: dist/

      - name: üöÄ Deploy to Firebase Preview
        uses: FirebaseExtended/action-hosting-deploy@v0
        id: firebase-deploy
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_GESTOS_GASTOSV2 }}'
          projectId: gastos-hormigas
          expires: 7d

      - name: üí¨ Comment preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.firebase-deploy.outputs.details_url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `
              ## üöÄ Preview Deploy Listo!
              
              **üåê URL de Preview**: [Ver aplicaci√≥n](${ previewUrl })
              
              ### üß™ Cosas para probar:
              - [ ] Funcionalidad principal
              - [ ] Responsive design
              - [ ] PWA installation
              - [ ] Modo offline
              - [ ] Performance
              
              **‚è±Ô∏è Expira en**: 7 d√≠as
              **üîÑ Actualizado en**: ${{ github.event.pull_request.updated_at }}
              `
            });

  # ===== AN√ÅLISIS DE CAMBIOS =====
  analyze-changes:
    name: üìä Analyze Changes
    runs-on: ubuntu-latest
    needs: pr-validation
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìä Analyze file changes
        run: |
          echo "üìä Analizando cambios..."
          
          # Contar archivos cambiados
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          
          # Contar l√≠neas agregadas/eliminadas
          LINES_ADDED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ insertions?' | grep -oE '[0-9]+' || echo "0")
          LINES_DELETED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ deletions?' | grep -oE '[0-9]+' || echo "0")
          
          # Verificar tipos de archivos
          TS_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx)$' | wc -l)
          TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.test\.(ts|tsx)$' | wc -l)
          
          echo "FILES_CHANGED=$FILES_CHANGED" >> $GITHUB_ENV
          echo "LINES_ADDED=$LINES_ADDED" >> $GITHUB_ENV
          echo "LINES_DELETED=$LINES_DELETED" >> $GITHUB_ENV
          echo "TS_FILES=$TS_FILES" >> $GITHUB_ENV
          echo "TEST_FILES=$TEST_FILES" >> $GITHUB_ENV

      - name: üí¨ Comment change analysis
        uses: actions/github-script@v7
        with:
          script: |
            const analysis = `
            ## üìä An√°lisis de Cambios
            
            | M√©trica | Valor |
            |---------|-------|
            | üìÅ Archivos cambiados | ${{ env.FILES_CHANGED }} |
            | ‚ûï L√≠neas agregadas | ${{ env.LINES_ADDED }} |
            | ‚ûñ L√≠neas eliminadas | ${{ env.LINES_DELETED }} |
            | üìù Archivos TypeScript | ${{ env.TS_FILES }} |
            | üß™ Archivos de test | ${{ env.TEST_FILES }} |
            
            ${parseInt('${{ env.TEST_FILES }}') === 0 && parseInt('${{ env.TS_FILES }}') > 0 ? 
              '‚ö†Ô∏è **Consideraci√≥n**: Se modificaron archivos TypeScript pero no se agregaron tests.' : 
              '‚úÖ Los cambios incluyen archivos de test apropiados.'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: analysis
            });

  # ===== CLEANUP AL CERRAR PR =====
  cleanup-preview:
    name: üßπ Cleanup Preview
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    
    steps:
      - name: üßπ Clean up preview artifacts
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üßπ Preview deployment limpiado. ¬°Gracias por tu contribuci√≥n!'
            });
