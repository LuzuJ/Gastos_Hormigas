name: ğŸ·ï¸ Release Automation

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3)'
        required: true
        default: '1.0.0'
      release_type:
        description: 'Release type'
        required: true
        default: 'release'
        type: choice
        options:
        - release
        - prerelease
        - hotfix

env:
  NODE_VERSION: '18'

jobs:
  # ===== CREAR RELEASE =====
  create-release:
    name: ğŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    
    outputs:
      release-version: ${{ steps.version.outputs.version }}
      release-notes: ${{ steps.notes.outputs.notes }}
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Version: $VERSION"

      - name: ğŸ“ Generate release notes
        id: notes
        run: |
          # Obtener Ãºltimo tag
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git rev-list --max-parents=0 HEAD)
          
          # Generar changelog
          echo "## ğŸš€ Gastos Hormigas v${{ steps.version.outputs.version }}" > release_notes.md
          echo "" >> release_notes.md
          echo "### âœ¨ Nuevas CaracterÃ­sticas" >> release_notes.md
          git log --pretty=format:"- %s" $LAST_TAG..HEAD --grep="feat" >> release_notes.md || true
          echo "" >> release_notes.md
          echo "### ğŸ› Correcciones" >> release_notes.md
          git log --pretty=format:"- %s" $LAST_TAG..HEAD --grep="fix" >> release_notes.md || true
          echo "" >> release_notes.md
          echo "### ğŸ“š DocumentaciÃ³n" >> release_notes.md
          git log --pretty=format:"- %s" $LAST_TAG..HEAD --grep="docs" >> release_notes.md || true
          echo "" >> release_notes.md
          echo "### ğŸ”§ Mejoras TÃ©cnicas" >> release_notes.md
          git log --pretty=format:"- %s" $LAST_TAG..HEAD --grep="refactor\|perf\|chore" >> release_notes.md || true
          
          # Agregar informaciÃ³n adicional
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "### ğŸ“Š EstadÃ­sticas de la Release" >> release_notes.md
          echo "- **Commits**: $(git rev-list --count $LAST_TAG..HEAD)" >> release_notes.md
          echo "- **Archivos cambiados**: $(git diff --name-only $LAST_TAG..HEAD | wc -l)" >> release_notes.md
          echo "- **Contribuidores**: $(git shortlog -sn $LAST_TAG..HEAD | wc -l)" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ğŸŒ Enlaces" >> release_notes.md
          echo "- [ğŸ“± AplicaciÃ³n en vivo](https://gestos-gastosv2.web.app)" >> release_notes.md
          echo "- [ğŸ“– DocumentaciÃ³n](./README.md)" >> release_notes.md
          echo "- [ğŸ—ï¸ Arquitectura](./ARCHITECTURE.md)" >> release_notes.md
          
          # Guardar en output
          {
            echo 'notes<<EOF'
            cat release_notes.md
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: ğŸš€ Gastos Hormigas v${{ steps.version.outputs.version }}
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}

  # ===== BUILD DE RELEASE =====
  build-release:
    name: ğŸ—ï¸ Build Release
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run full test suite
        run: npm run test -- --coverage
        continue-on-error: true
        env:
          CI: true

      - name: ğŸ—ï¸ Build production release
        run: npm run build
        env:
          VITE_APP_VERSION: v${{ needs.create-release.outputs.release-version }}
          VITE_APP_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: ğŸ“¦ Create release archive
        run: |
          cd dist
          tar -czf ../gastos-hormigas-v${{ needs.create-release.outputs.release-version }}.tar.gz .
          cd ..
          zip -r gastos-hormigas-v${{ needs.create-release.outputs.release-version }}.zip dist/

      - name: ğŸ“¤ Upload release assets
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: |
            gastos-hormigas-v${{ needs.create-release.outputs.release-version }}.tar.gz
            gastos-hormigas-v${{ needs.create-release.outputs.release-version }}.zip

  # ===== DEPLOY RELEASE =====
  deploy-release:
    name: ğŸš€ Deploy Release
    runs-on: ubuntu-latest
    needs: [create-release, build-release]
    environment:
      name: production
      url: https://gestos-gastosv2.web.app
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets

      - name: ğŸ“¦ Extract build files
        run: |
          tar -xzf gastos-hormigas-v${{ needs.create-release.outputs.release-version }}.tar.gz

      - name: ğŸš€ Deploy to Firebase Production
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_GESTOS_GASTOSV2 }}'
          projectId: gastos-hormigas
          channelId: live

      - name: ğŸ‰ Release deployment success
        run: |
          echo "ğŸ‰ Â¡Release v${{ needs.create-release.outputs.release-version }} desplegada exitosamente!"
          echo "ğŸŒ URL: https://gestos-gastosv2.web.app"
          echo "ğŸ“Š Version: v${{ needs.create-release.outputs.release-version }}"

  # ===== NOTIFICACIONES =====
  notify-release:
    name: ğŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: [create-release, deploy-release]
    if: always()
    
    steps:
      - name: ğŸ“¢ Success notification
        if: needs.deploy-release.result == 'success'
        run: |
          echo "âœ… Release v${{ needs.create-release.outputs.release-version }} completada"
          echo "ğŸš€ AplicaciÃ³n actualizada en producciÃ³n"
          
      - name: âŒ Failure notification
        if: failure()
        run: |
          echo "âŒ Release v${{ needs.create-release.outputs.release-version }} fallÃ³"
          echo "ğŸ” Revisar logs para mÃ¡s detalles"
